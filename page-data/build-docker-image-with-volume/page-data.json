{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/build-docker-image-with-volume","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://goznauk.github.io"}},"markdownRemark":{"id":"ea82b5a2-e0c3-564f-9007-a4703d94ad39","excerpt":"Docker Build시에 volume mount가 당연히 가능할 줄 알고 inference model이나 pip cache 등을 volume 으로 넣어주려고 했으나…  그러던 차에 StackOverFlow의 글을 발견했다. BuildKit을 사용하면 가능하다고. dockerfile…","html":"<p>Docker Build시에 volume mount가 당연히 가능할 줄 알고 inference model이나 pip cache 등을 volume 으로 넣어주려고 했으나…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 241px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f27c1213413301820c644089fe4241d2/87673/impossible.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.72199170124482%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACNklEQVQ4y41TaW/aQBDl//+RfG9FBWlFFRLRRMGSDwrYGBvXNj4wYA5fa+86z15yKEVq58Nqd3bevJm3s508zy3L2m63m82GUsoYq//bOkVRuK6bJMl+vwcYG6Q7nU7w/xv8twswz/NM06wpbc5YP5bzYd9hrfEDIQS0/Loqy9JcUesPDUIaBOycfEI2YMRQzlDXx+NxvV77vs/TsTRlWdZwWza1nQtxmtav8R2oVVVVm/RSwm63C4Kg8bRBJI7P338wcwUMI6TSNIbqOBgKGYahaZqu67PW9nEcuO6xja6enmLbXhvGRtdLRaGOW8pKqap1WV4Eg9phGIIQOqHmc5KkSbK6uakd9zAYAImYeDLxe33qB6U8Ib8eOXkDhrDz+Xw6nYqiqMgy3sy17ejL19pc2cP737KMmNRcKf3bne3QhwciCJeyQYvovM2EnklRxIeDKgiTbrcOw5kgfOt2UYkoSbc/B5Fl1WOhRC2tHJ0sy1AzxouvvucFUZRD88UC14/Pz4qiQFG0I0mSbVmEsSoI33tuB4GS1jCfzWNG25KQtee5joOmMLx4QijSZA/DQF9CuQv40zxDjML3Z5qWphAuQcaqtbcA0zBybQHCK+NZ50VuO9pyKYnieDzmivCxRwtzVb0fDmm0BecVMMtytjTSLHMcp8hzrCgYumJyZtOp4/skiqqFfv1jNINVEABGoxGYseGtDe/u+r1eI5CqVdriOpgbmgQn/iZ65h78giRNKZp/9bwAaYfCMCQlgEYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"impossible\"\n        title=\"impossible\"\n        src=\"/static/f27c1213413301820c644089fe4241d2/87673/impossible.png\"\n        srcset=\"/static/f27c1213413301820c644089fe4241d2/00d96/impossible.png 148w,\n/static/f27c1213413301820c644089fe4241d2/87673/impossible.png 241w\"\n        sizes=\"(max-width: 241px) 100vw, 241px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>그러던 차에 <a href=\"https://stackoverflow.com/questions/58018300/using-a-pip-cache-directory-in-docker-builds\">StackOverFlow의 글</a>을 발견했다.</p>\n<p><a href=\"https://github.com/moby/buildkit\">BuildKit</a>을 사용하면 가능하다고.</p>\n<ul>\n<li>dockerfile:experimental을 Pull 하고</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker pull docker/dockerfile:experimental</code></pre></div>\n<ul>\n<li>Dockerfile 상단에 다음과 같은 주석을 추가해 주고</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># syntax = docker/dockerfile:experimental</span>\n<span class=\"token keyword\">FROM</span> some/docker<span class=\"token punctuation\">:</span>image</code></pre></div>\n<ul>\n<li>필요한 곳에 <code class=\"language-text\">RUN</code> 대신 <code class=\"language-text\">RUN --mount=........</code>를 사용한다.</li>\n<li>안타깝게도 bind는 read만 가능한듯?</li>\n<li><code class=\"language-text\">type=cache</code>가 유용해 보임</li>\n<li>더 자세한 옵션은 <a href=\"https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md#run---mounttypebind-the-default-mount-type\">이 곳</a> 참조</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Cache pip packages</span>\n<span class=\"token keyword\">RUN</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/root/.cache/pip pip install some<span class=\"token punctuation\">-</span>package\n<span class=\"token comment\"># Cache apt packages</span>\n<span class=\"token keyword\">RUN</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/var/cache/apt <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/var/lib/apt \\\n  apt update &amp;&amp; apt<span class=\"token punctuation\">-</span>get <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>install<span class=\"token punctuation\">-</span>recommends install <span class=\"token punctuation\">-</span>y gcc</code></pre></div>\n<ul>\n<li>실행시 DOCKER_BUILDKIT을 1로 주면 된다. (docker-compose build도 동일하게 가능)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># set env variable $DOCKER_BUILDKIT to 1</span>\n<span class=\"token assign-left variable\">DOCKER_BUILDKIT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> docker build -t my-image <span class=\"token builtin class-name\">.</span></code></pre></div>","fields":{"slug":"build-docker-image-with-volume"},"frontmatter":{"title":"Build docker image with volume mount","date":"14 Mar, 2020","description":"Use volume while building docker","tags":["docker","build","cache"],"cover":{"publicURL":"/static/preview-2ac34c55c915457bc4c6af9aa8a865d2.png","childImageSharp":{"fluid":{"tracedSVG":"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='62'%20height='62'%3e%3cpath%20d='M23%2014c-3%201-3%201-2%205%200%204%200%205-3%206-2%201-2%202-2%204l-1%203-2-1v-4c0-6-2-9-5-7l-2%204H3c-3%200-3%200-3%204%200%203%201%204%204%204%203%201%203%202%203%205%200%2015%2012%2026%2028%2025l10-2h-3c-7%201-14%201-19-1l-5-2%203-2%205-4%201-2%202%202c2%204%207%206%2013%207%205%201%209%200%207-2l1-1c5%200%2012-11%2012-18%200-8-5-16-9-15s-9-1-9-4c0-2-1-3-2-3-3-2-16-2-19-1'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":1.0833333333333333,"src":"/static/2ac34c55c915457bc4c6af9aa8a865d2/9ad2a/preview.png","srcSet":"/static/2ac34c55c915457bc4c6af9aa8a865d2/d167a/preview.png 293w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/9d9a7/preview.png 585w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/9ad2a/preview.png 637w","srcWebp":"/static/2ac34c55c915457bc4c6af9aa8a865d2/7789d/preview.webp","srcSetWebp":"/static/2ac34c55c915457bc4c6af9aa8a865d2/05ceb/preview.webp 293w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/5c538/preview.webp 585w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/7789d/preview.webp 637w","sizes":"(max-width: 637px) 100vw, 637px"}}}}},"allMarkdownRemark":{"edges":[]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"build-docker-image-with-volume","previous":{"fields":{"slug":"android-multithreading"},"frontmatter":{"title":"Android Multithreading","tags":["java","android","multithreading"]}},"next":null,"tag":["docker","build","cache"]}}}