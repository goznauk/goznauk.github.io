{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/build-docker-image-with-volume","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://goznauk.github.io"}},"markdownRemark":{"id":"ea82b5a2-e0c3-564f-9007-a4703d94ad39","excerpt":"Docker Build시에 volume mount가 당연히 가능할 줄 알고 inference model이나 pip cache 등을 volume 으로 넣어주려고 했으나…  그러던 차에 StackOverFlow의 글을 발견했다. BuildKit을 사용하면 가능하다고. dockerfile…","html":"<p>Docker Build시에 volume mount가 당연히 가능할 줄 알고 inference model이나 pip cache 등을 volume 으로 넣어주려고 했으나…</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 241px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f27c1213413301820c644089fe4241d2/87673/impossible.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.72199170124482%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsSAAALEgHS3X78AAACNklEQVQ4y41TaW/aQBDl//+RfG9FBWlFFRLRRMGSDwrYGBvXNj4wYA5fa+86z15yKEVq58Nqd3bevJm3s508zy3L2m63m82GUsoYq//bOkVRuK6bJMl+vwcYG6Q7nU7w/xv8twswz/NM06wpbc5YP5bzYd9hrfEDIQS0/Loqy9JcUesPDUIaBOycfEI2YMRQzlDXx+NxvV77vs/TsTRlWdZwWza1nQtxmtav8R2oVVVVm/RSwm63C4Kg8bRBJI7P338wcwUMI6TSNIbqOBgKGYahaZqu67PW9nEcuO6xja6enmLbXhvGRtdLRaGOW8pKqap1WV4Eg9phGIIQOqHmc5KkSbK6uakd9zAYAImYeDLxe33qB6U8Ib8eOXkDhrDz+Xw6nYqiqMgy3sy17ejL19pc2cP737KMmNRcKf3bne3QhwciCJeyQYvovM2EnklRxIeDKgiTbrcOw5kgfOt2UYkoSbc/B5Fl1WOhRC2tHJ0sy1AzxouvvucFUZRD88UC14/Pz4qiQFG0I0mSbVmEsSoI33tuB4GS1jCfzWNG25KQtee5joOmMLx4QijSZA/DQF9CuQv40zxDjML3Z5qWphAuQcaqtbcA0zBybQHCK+NZ50VuO9pyKYnieDzmivCxRwtzVb0fDmm0BecVMMtytjTSLHMcp8hzrCgYumJyZtOp4/skiqqFfv1jNINVEABGoxGYseGtDe/u+r1eI5CqVdriOpgbmgQn/iZ65h78giRNKZp/9bwAaYfCMCQlgEYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"impossible\"\n        title=\"impossible\"\n        src=\"/static/f27c1213413301820c644089fe4241d2/87673/impossible.png\"\n        srcset=\"/static/f27c1213413301820c644089fe4241d2/00d96/impossible.png 148w,\n/static/f27c1213413301820c644089fe4241d2/87673/impossible.png 241w\"\n        sizes=\"(max-width: 241px) 100vw, 241px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>그러던 차에 <a href=\"https://stackoverflow.com/questions/58018300/using-a-pip-cache-directory-in-docker-builds\">StackOverFlow의 글</a>을 발견했다.</p>\n<p><a href=\"https://github.com/moby/buildkit\">BuildKit</a>을 사용하면 가능하다고.</p>\n<ul>\n<li>dockerfile:experimental을 Pull 하고</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">docker pull docker/dockerfile:experimental</code></pre></div>\n<ul>\n<li>Dockerfile 상단에 다음과 같은 주석을 추가해 주고</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># syntax = docker/dockerfile:experimental</span>\n<span class=\"token keyword\">FROM</span> some/docker<span class=\"token punctuation\">:</span>image</code></pre></div>\n<ul>\n<li>필요한 곳에 <code class=\"language-text\">RUN</code> 대신 <code class=\"language-text\">RUN --mount=........</code>를 사용한다.</li>\n<li>안타깝게도 bind는 read만 가능한듯?</li>\n<li><code class=\"language-text\">type=cache</code>가 유용해 보임</li>\n<li>더 자세한 옵션은 <a href=\"https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md#run---mounttypebind-the-default-mount-type\">이 곳</a> 참조</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># Cache pip packages</span>\n<span class=\"token keyword\">RUN</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/root/.cache/pip pip install some<span class=\"token punctuation\">-</span>package\n<span class=\"token comment\"># Cache apt packages</span>\n<span class=\"token keyword\">RUN</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/var/cache/apt <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>mount=type=cache<span class=\"token punctuation\">,</span>target=/var/lib/apt \\\n  apt update &amp;&amp; apt<span class=\"token punctuation\">-</span>get <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>install<span class=\"token punctuation\">-</span>recommends install <span class=\"token punctuation\">-</span>y gcc</code></pre></div>\n<ul>\n<li>실행시 DOCKER_BUILDKIT을 1로 주면 된다. (docker-compose build도 동일하게 가능)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># set env variable $DOCKER_BUILDKIT to 1</span>\n<span class=\"token assign-left variable\">DOCKER_BUILDKIT</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> docker build -t my-image <span class=\"token builtin class-name\">.</span></code></pre></div>","fields":{"slug":"build-docker-image-with-volume"},"frontmatter":{"title":"Build docker image with volume mount","date":"14 Mar, 2020","description":"Use volume while building docker","tags":["docker","build","cache"],"cover":{"publicURL":"/static/preview-2ac34c55c915457bc4c6af9aa8a865d2.png","childImageSharp":{"fluid":{"tracedSVG":"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='1170'%20height='690'%3e%3cpath%20d='M148%204l-2%206-2%206-2%209c-3%208-1%2028%203%2040%202%206%202%207-1%203a108%20108%200%2000-69-38%20113%20113%200%2000-62%2012c-2%200-10%206-11%208l1%205%202%2010a217%20217%200%200035%2070c9%2012%2023%2025%2035%2031l4%203%201%201%209%204%2021%207%202%201a157%20157%200%200054%200v11a1198%201198%200%20001%20147%20245%20245%200%20008%2046%20353%20353%200%2000110%20182l1%202%202%202%2011%209%2014%2012a151%20151%200%200117%2011l2%203%202%201%204%202%205%204a84%2084%200%200111%207l5%203%207%204%205%203%203%201%203%201%2013%206%202%202%2016%208a509%20509%200%200133%2013l2%201c1-1%202%200%203%201l3%201%203%201%205%201%206%202%205%202%209%202%2011%203%206%201%204%201%203%201%205%201a3560%203560%200%200139%206%20663%20663%200%2000219-16l2-1%208-2%209-2%205-2%2010-3%2011-5%202-1%206-2a1155%201155%200%200138-19l20-11c20-11%2038-23%2038-26%200-2-18-15-33-24l-6-4%208-1%2011-2%207-1%207-1a225%20225%200%200124-5%20200%20200%200%200028-10%2084%2084%200%200045-35%20191%20191%200%200017-22%20257%20257%200%200027-41l4-7a275%20275%200%200018-35%20162%20162%200%20007-15%20196%20196%200%20009-20l6-17%204-15%201-3v-1l1-6%202-6%204-15%201-6a232%20232%200%20005-35%20572%20572%200%2000-5-90%201685%201685%200%2001-8-36%20285%20285%200%2001-6-18l-4-11c-6-15-8-19-14-28l-7-12-18-25c-12-18-33-40-40-44-4-2-5-2-22-2a256%20256%200%2000-47%204%20767%20767%200%2000-47%207h-4V9l-1-7c-1-2-13-2-240-2H408v2l2%208%203%2015c1%202-3%204-6%204l-3%201-4%202a747%20747%200%2000-68%2027c-12%204-27%2015-27%2018a805%20805%200%200018%2088v2h-9a1922%201922%200%2000-40-5l-9-2c-9-3-14-4-22-8-10-4-10-4-6-9l5-9%203-6%208-16a155%20155%200%2000-2-109l-1-3H149l-1%204m374%20213l1%201c3%200%204%2013%201%2019-4%208-17%2018-23%2018l-2%201c-2%202-11%203-20%202-16-2-23-15-16-28%203-5%202-5-4%201-9%209-21%2027-21%2033l-1%203c-2%202-2%2021%201%2028%208%2021%2025%2033%2050%2032%2017%200%2031-5%2045-16a76%2076%200%200021-32c2-1%202-23%200-26-6-13-9-18-13-23-6-7-19-15-19-13m-10%20229l-2%206-4%209a187%20187%200%2001-112%20107%20197%20197%200%2001-70%2013%20339%20339%200%200093%2054l1%201%202%201%204%201%2017%207a211%20211%200%200120%207l7%202%204%201%203%201%2011%203%204%201%207%202%2012%202a584%20584%200%2000152%208%20556%20556%200%2000138-28%20643%20643%200%2000100-41c7-4%207-5%203-4l-10%203a306%20306%200%2001-34%209%20295%20295%200%2001-232-38l-8-5-8-4-8-6-8-5-5-3-5-4a250%20250%200%2001-51-57l-5-8a154%20154%200%2001-12-34c0-7-2-8-4-1'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":1.0833333333333333,"src":"/static/2ac34c55c915457bc4c6af9aa8a865d2/9ad2a/preview.png","srcSet":"/static/2ac34c55c915457bc4c6af9aa8a865d2/d167a/preview.png 293w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/9d9a7/preview.png 585w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/9ad2a/preview.png 637w","srcWebp":"/static/2ac34c55c915457bc4c6af9aa8a865d2/7789d/preview.webp","srcSetWebp":"/static/2ac34c55c915457bc4c6af9aa8a865d2/05ceb/preview.webp 293w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/5c538/preview.webp 585w,\n/static/2ac34c55c915457bc4c6af9aa8a865d2/7789d/preview.webp 637w","sizes":"(max-width: 637px) 100vw, 637px"}}}}},"allMarkdownRemark":{"edges":[]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"build-docker-image-with-volume","previous":{"fields":{"slug":"android-multithreading"},"frontmatter":{"title":"Android Multithreading","tags":["java","android","multithreading"]}},"next":null,"tag":["docker","build","cache"]}}}