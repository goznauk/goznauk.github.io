{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/android-multithreading","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://goznauk.github.io"}},"markdownRemark":{"id":"18dec744-953f-5221-ba5b-f96171607818","excerpt":"Contents Android Threads 1.1. UI, Binder, Background Thread 1.2. Blocking UI Thread and ANR MultiThreading 2.1. Basic Usage 2.2. Multithreading Considerations…","html":"<blockquote>\n<p>Contents</p>\n<ol>\n<li>\n<p>Android Threads</p>\n<ul>\n<li>1.1. UI, Binder, Background Thread</li>\n<li>1.2. Blocking UI Thread and ANR</li>\n</ul>\n</li>\n<li>\n<p>MultiThreading</p>\n<ul>\n<li>2.1. Basic Usage</li>\n<li>2.2. Multithreading Considerations</li>\n<li>2.3. Thread Safety</li>\n<li>2.4. Task Execution Strategies</li>\n<li>2.5. MultiThreading on Android : UI Thread Only</li>\n</ul>\n</li>\n<li>\n<p>Thread Communication in Java</p>\n<ul>\n<li>3.1. Pipes</li>\n<li>3.2. Shared Memory</li>\n<li>3.3. Blocking Queue</li>\n</ul>\n</li>\n<li>\n<p>Thread Communication in Android</p>\n<ul>\n<li>4.1. Android Message handling Mechansim</li>\n<li>4.2. MessageQueue</li>\n<li>4.3. Message</li>\n<li>4.4. Looper</li>\n<li>4.5. Handler</li>\n<li>4.6. HandlerThread</li>\n</ul>\n</li>\n<li>\n<p>Asynctask</p>\n<ul>\n<li>5.1. Overall</li>\n<li>5.2. Usage</li>\n<li>5.3. Pitfalls</li>\n</ul>\n</li>\n<li>Executor</li>\n<li>IntentService</li>\n<li>Loader</li>\n<li>Select MultiThreading Method</li>\n</ol>\n</blockquote>\n<hr>\n<p>안드로이드 애플리케이션을 개발하다 보면 비동기 작업이나 UI 반응을 위해 스레드를 사용할 일이 많이 생긴다. 안드로이드에서는 멀티스레딩을 위해 몇 가지 방법을 제공하고 있으며, API 문서만 읽고도 손쉽게 적용할 수 있게 되어 있으나 자세하게 정리하고자 이 글을 작성하였다.</p>\n<h3>1. Android Threads</h3>\n<p>안드로이드 애플리케이션이 시작되는 과정을 살펴보면, Linux Process를 만들고, 그 위에 Dalvik VM runtime을 띄워 Application Class의 Instance를 생성, Instance가 가지고 있는 Entry Point Component를 실행한다. 이 과정에서 Linux Process와 Dalvik VM을 관리하는 많은 스레드들이 생성되는데, 이 중 UI thread와 Binder thread는 Application에서 사용되며, Application이 자체적으로 Background thread를 만들어 사용할 수도 있다.</p>\n<h4>1.1. UI, Binder, Background Thread</h4>\n<p>안드로이드 애플리케이션에서 사용하는 모든 스레드는 Linux native pthread(POSIX Thread)의 자바 구현체이다. 하지만 Android Platform은 역할에 따라 UI, Binder, Background thread로 나누어 각각에 특별한 속성들을 부여했다.</p>\n<p>UI Thread는 간단히 말하면 Main thread이다. 애플리케이션이 시작되어 프로세스가 종료될 때까지 유지되며, UI elements에 접근할 수 있는 유일한 스레드이다. (모든 Thread는 Linux native thread로 Linux에서는 동등하게 취급되기 때문에 Application Framework Layer의 WindowManager에서 UI thread 이외의 접근을 제한한다) Activity에서 실행하는 코드들은 별다른 스레딩을 하지 않았다면 UI thread에서 실행된다. UI elements들의 이벤트들을 순차적으로 처리하기 때문에 시간이 오래 걸리는 이벤트를 실행하면 UI 전체가 멈추게 된다.</p>\n<p>Binder Thread는 IPC(InterProcess Communication)를 위한 스레드로, 모든 프로세스는 Binder thread를 위한 thread pool을 가진다. 이 스레드풀은 임의로 제거되거나 생성할 수 없으며, Intent, Content Provider, Service 등 다른 프로세스의 요청을 핸들링하게 된다. Binder를 사용할 경우를 제외하고는 생각하지 않아도 되는 thread로, Binder란 Linux IPC를 대체한 안드로이드 커널만의 프레임워크로, 프로세스 간의 RPC(Remote Procedure Calls)를 제공하는 것인데, 추후에 다른 글에서 다루기로 한다.</p>\n<p>Background Thread는 애플리케이션이 필요할 때 생성하는 thread로 UI thread의 속성들을 상속받는다. 자유롭게 생성하고 실행이 가능하며, 일반적인 애플리케이션을 개발할 때 가장 신경써야 할 thread이다. 앞으로 다룰 Threading에 관한 내용은 거의 Background Thread에 대한 내용이라고 볼 수 있다.</p>\n<h4>1.2. Blocking UI Thread and ANR</h4>\n<p>사용자와 인터렉션하는 GUI 애플리케이션들의 경우, 사용자경험 측면에서 즉각적인 응답을 주는 것이 매우 중요하다. 사용자는 화면이 멈추고 아무런 입력도 할 수 없는 상태가 자주 일어나는 애플리케이션에 결코 좋은 평가를 하지 않을 것이다. 이런 이유로 윈도우의 ‘응답 없음’과 같이, 어떤 이벤트가 발생한 후 일정 시간동안 응답이 없는 경우 OS단에서 앱을 중지할 것인지 물어보는 (과격한) 정책들이 사용되고 있다.</p>\n<p>Android에서는 UI Thread가 UI elements들의 이벤트들을 순차적으로 실행하는 까닭에 어떤 element의 이벤트가 오랜 시간 실행된다면 전체 UI가 다른 이벤트를 받지 못하고 멈추게 된다. 이 상태로 약 5초가 지나면 Android OS는 ANR(Application Not Responding) 메시지를 띄우며 사용자가 앱을 종료할 것인지 묻게 된다. 이 때 사용자가 당신의 애플리케이션이 완벽하다는 믿음을 가지고 종료하지 않고 기다려 주는 경우는 사용자가 당신 혹은 당신의 동료일 경우 뿐이다. 대부분의 사용자는 망설이지 않고 종료 버튼을 누를 것이며, 다시는 당신의 애플리케이션을 이용하지 않을 확률이 높다.</p>\n<p>이 경우 사용자에게 비현실적인 것을 기대하기보다는 Background Thread를 사용해 비동기적으로 처리해 주고, 기다리는 동안은 처리되고 있다는 알림을 - 필수는 아니지만 - 띄우는 편이 사용자에게 더 큰 만족감을 줄 것이다. 더 나아가 안드로이드는 시간이 많이 걸리는 작업들 - 네트워크 등(더 찾아보기) - 을 Background Thread에서 처리하도록 (찾아봐야댐)버전 몇부터는 정책적으로 강제하였다. 다시 말해 Background Thread을 사용해야 하는 부분은 안드로이드 개발에 있어 빼놓을 수 없는 부분이며, Android MultiThreading에 대한 깊은 이해가 필요하다고 볼 수 있다.</p>\n<h3>2. MultiThreading</h3>\n<p>안드로이드의 스레드에 대해 더 살펴보기 전에, 기본적인 스레드에 대해 더 알아보자. 스레드란 프로세스 내에서 실행되는 흐름의 단위를 뜻하는 말로, 코드의 실행 흐름을 새로 만들 때 사용된다. 일반적으로 한 프로세스는 하나 이상의 스레드를 가지는데, 한 스레드 안에서 코드는 항상 순차적으로 실행된다.</p>\n<p>(TODO 예시 수정할 것)\n이해를 돕기 위해 라면을 끓이는 상황을 생각해 보자.</p>\n<blockquote>\n<p>불을 켜고(Task A) 1초에 한 번씩 물이 끓는 지 보다 물이 끓으면(wait) 라면을 넣는다(Task B)는 코드를 한 스레드 안에서 실행하면 불을 켜고(Task A 실행) 가만히 서서 냄비를 바라보다(wait) 라면을 넣을 것이다(Task B 실행).</p>\n</blockquote>\n<p>위의 예시에서 당신은 물이 끓을 때까지 1초에 한번씩 냄비를 확인하며 가만히 서있어야 할 것이다. 다행스럽게도, 당신에게는 Thread라는 로봇이 있다. 불을 켜고(Task A) Thread를 불러(thread 생성) 물이 끓는 것을 확인한 후(wait) 면을 넣으라(Task B)는 이야기를 해 놓고 쇼파에 누워 페이스북(Task C)을 할 수 있을 것이다.</p>\n<h4>2.1. Basic Usage</h4>\n<p>Java의 Thread는 <code class=\"language-text\">java.lang.Thread</code>에 구현되어 있다. Thread는 어떤 task를 실행하면서 시작되고, task의 실행이 끝나 더 이상 실행할 task가 없는 경우 제거된다. task의 구현은 <code class=\"language-text\">java.lang.Runnable</code> interface를 통해 구현할 수 있다. 기본적인 thread의 사용법은 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CountTask</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>count<span class=\"token operator\">&lt;</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Count: \"</span> <span class=\"token operator\">+</span> count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Thread</span> otherThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CountTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\notherThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 코드에서 CountTask의 <code class=\"language-text\">run()</code> 메서드 내부의 변수는 새로 만들어진 otherThread의 local memory stack에 저장된다. 각각의 thread는 각각의 instruction pointer와 stack pointer를 가지며, 이 stack pointer는 thread-local memory stack의 변수를 가리킨다. thread-local memory stack은 다른 스레드에서 접근할 수 없는 영역이다.</p>\n<h4>2.2. Multithreading Considerations</h4>\n<p>여러 개의 스레드를 사용함으로서 얻는 이점들도 있지만, 그에 대해 지불해야 하는 cost도 적지 않다. 모든 코드가 순차적으로 실행되는 Single-threaded 애플리케이션에 비해 MultiThreaded 애플리케이션의 경우 스레드 수만큼의 실행 흐름에 대해 고려해야 하며, 그에 따라 에러가 발생할 확률이 높아지고 디버깅이 어려워진다. 서로 다른 스레드 - 실행 흐름 - 상에서 돌아가는 코드들의 순서가 nondeterministic하기 때문에 고려해야 할 문제도 많다. 단순하게 코드가 복잡하고 예측하기 어려워지는 것 뿐 아니라 공유된 자원에 접근할 경우 의도대로 코드가 작동하지 않는 문제가 있다.</p>\n<p>예를 들어, 두 스레드 A, B가 있다고 하자. 두 스레드 A, B는 모두 공유된 자원 <code class=\"language-text\">count</code>에 접근하는데, A는 <code class=\"language-text\">count</code>를 증가시키고, B는 감소시킨다. Java 코드로 표현하면 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RaceCondition</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> count<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Thread</span> threadA <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Thread</span> threadB <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                count<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        threadA<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        threadB<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>단순하게 생각했을 때, 출력은 1, 0, 0이 되어야 한다. 그러나 위 코드를 실행해 보면, 출력은 항상 - 같은 환경에서 테스트할 경우 확률적으로 한 개의 결과를 더 많이 보여줄 수는 있으나 - 다른 결과를 보여준다. 스레드 A가 B보다 먼저 실행된느 것을 보장할 수 없다는 것이다. 비단 실행 순서의 문제일까? 세 번째 출력은 항상 0일까?</p>\n<p>최종적으로 <code class=\"language-text\">count</code>가 가지는 값은 0일 수도 있지만, 1 혹은 -1이 될 수도 있다. <code class=\"language-text\">count</code>가 Race Condition(경쟁 상태)에 있기 때문이다. Race Condition이란 공유 자원에 대해 여러 개의 접근이 동시에 이루어지는 상태를 말한다. 다행스럽게도 스레드 B가 A의 작업이 끝난 후 - <code class=\"language-text\">count</code>가 0에서 1로 바뀐 후 - 혹은 A가 B의 작업이 끝난 후에 실행된다면 <code class=\"language-text\">count</code>는 최종적으로 0이 되겠지만, 만약 A와 B가 동시에 - count가 0일 때 - <code class=\"language-text\">count</code>에 접근해 작업을 실행한다면 최종적으로 <code class=\"language-text\">count</code>는 -1이나 1의 값을 가지게 된다.</p>\n<h4>2.3. Thread Safety</h4>\n<p>멀티스레드 환경에서는 위와 같이 공유된 자원에 여러 스레드에서 접근하는 상황이 자주 발생하게 된다. 여러 스레드에서 하나의 자원을 공유하는 것은 하나의 writer와 여러 개의 reader가 있을 경우 성능적인 측면에서 좋은 선택일 수 있지만, 개발자는 항상 실수를 하기 마련이므로 Thread Safety에 대한 고민이 필요하다. Thread Safety란 어떤 함수나 변수, 혹은 객체가 여러 스레드로부터 동시에 접근이 이루어져도 프로그램의 실행에 문제가 없음을 뜻하는 말이다. 하나의 함수가 한 스레드에서 호출되어 실행될 때, 다른 스레드에서 같은 함수를 호출해 동시에 실행되더라도 각각의 스레드에서 함수가 올바르게 작동해야 한다는 것이다.</p>\n<p>그렇다면 어떻게 Thread Safety하도록 만들 수 있을까? 공유된 자원이 없도록 만들면 된다. Thread-local storage를 사용하는 등 Re-Enterancy(재진입성)를 가지는 함수만을 사용하면 된다. Re-Enterancy를 가지는 함수란 언제나 다시 실행해도 같은 결과를 가지는 것으로, 간단히 이야기하면 호출 시 제공한 파라미터만으로 동작하는 전역 변수와 무관하게 돌아가는 함수를 말한다. 그러나 공유된 자원을 꼭 사용해야 하는 경우도 있다. 이러한 경우 세마포어 등의 락으로 상호 배제를 만들거나, atomically 하게 실행하도록 - 한 번에 하나의 스레드에서만 실행하도록 - 만들면 된다. 이렇게 atomically하게 실행되는 코드 영역을 critical section(임계영역)이라고 한다.</p>\n<p>Java에서는 <code class=\"language-text\">synchronized</code> 키워드나 <code class=\"language-text\">java.util.concurrent.locks.ReentrantLock</code> 패키지를 사용하여 atomic execution을 구현할 수 있다. 두 가지 방법 모두 critical section이 atomical하게 실행되도록 다른 모든 thread를 block하는 방식으로 동작한다.</p>\n<p><code class=\"language-text\">synchronized</code> 키워드는 세 가지 방법으로 사용될 수 있는데, 각각에 대한 예시 코드를 보자.</p>\n<ul>\n<li>해당 함수가 실행되고 있는 동안 동기화를 보장</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">someMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Do something...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>해당 블록 내에서 동기화를 보장</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">someMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Do Something...</span>\n    <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Do something...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Do Something...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>해당 블록 내에서 해당 변수에 대해 동기화를 보장</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">someMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> sth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Do something...</span>\n    <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>sth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Do something...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Do something...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">ReentrantLock</code>의 경우 <code class=\"language-text\">synchronized</code> 키워드에 비해 더 많은 기능을 제공한다. <code class=\"language-text\">ReentrantLock</code>은 Lock 인터페이스의 구현체로서, 타임아웃애 있는 Lock, Polling Lock 등을 지원한다. Lock 인터페이스와 간단한 사용법을 소개하고 넘어가도록 한다. 더 자세한 설명은 <a href=\"http://ismydream.tistory.com/51\">이 포스트</a>에 잘 설명되어 있다.</p>\n<ul>\n<li>Lock Interface</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Lock</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">lockInterruptibly</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">tryLock</span><span class=\"token punctuation\">(</span> <span class=\"token keyword\">long</span> timeout<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span> <span class=\"token function\">unit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Condition</span> <span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>Example</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Lock</span> mLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmLock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Do something...</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    mLock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>2.4. Task Execution Strategies</h4>\n<p>여러 개의 스레드를 사용할 경우 스레드를 적재적소에 사용하는 것이 매우 중요한데, 하나의 스레드에서 모든 일을 처리하는 경우 프로그램은 unresponsive하게 될 것이고, task 하나당 하나의 스레드를 사용하는 경우 context switching, thread communication 등의 overhead가 성능을 떨어뜨릴 것이다. 그렇다면 어떻게 task execution을 수행할 것인가? Sequential execution과 Concurrent execution에 대해 살펴보자.</p>\n<p>Sequential execution은 task들이 순차적으로 실행되는 것을 말한다. 이 경우 하나의 스레드에서 실행하는 것이 효율적이며, 당연하게도 Thread Safe하다. 하지만 throughput이 낮고, 중간에 오래 걸리는 task가 있다면 그 후의 모든 task들이 delay되거나 실행되지 않을 수 있다.</p>\n<p>Concurrent execution의 경우 task들이 parallel하게 실행되기 때문에 CPU를 효율적으로 사용할 수 있으나, Thread Safety를 보장할 수 없으므로 synchronization이 필요하다. Concurrent execution을 구현할 경우 많은 방법이 있으나 thread를 재사용하거나 너무 과도하게 사용하지 않도록 해야 한다.</p>\n<p>효율적인 프로그램을 만드려면 실행하려는 task들에 따라 sequential execution과 concurrent execution을 적절히 사용해야 한다.</p>\n<h4>2.5. MultiThreading on Android : UI Thread Only</h4>\n<p>다시 안드로이드로 돌아와 안드로이드의 UI Thread를 살펴보자. 앞서 UI Element에 대한 접근은 Application Framework Layer에서 WindowManager를 통해 제한한다고 이야기했다. 왜 이런 제한을 걸었을까? UI Element를 조작하는 과정을 생각해보자. UI Element들은 단순히 Activity - 혹은 View - 의 인스턴스 필드라고 생각하기 쉬우나, (조사 필요) 실제로는 조금 더 복잡하다. 그러나 UI Element 들에 접근할 때 synchronization에 신경써야 하지는 않는다. Android Runtime이 UI elements들에 대해 single-threaded로 작동하도록 강제함으로서 concurrency problems에 대해 자유로워질 수 있는 것이다.</p>\n<h3>3. Thread Communication in Java</h3>\n<p>지금까지 안드로이드에서 멀티스레딩이 필요한 이유와 방법에 대해 살펴보았다. 안드로이드만의 스레드 통신 방법인 Handler/Looper에 대해 이야기하기 전에 Java의 Thread 통신 방법들을 먼저 알아보자.</p>\n<h4>3.1. Pipes</h4>\n<p>[그림]</p>\n<p><code class=\"language-text\">java.io</code> 패키지의 Pipe는 단방향 데이터 채널을 위해 사용되는 것으로, POSIX의 pipe operator와 비슷한 기능을 하지만, 프로세스 간의 통신을 하는 POSIX pipe와는 달리 VM 위의 스레드 사이에서 output redirecting을 한다. Pipe에 데이터를 쓰는 스레드를 Producer 스레드라 하고, Pipe에서 데이터를 읽는 스레드를 Consumer 스레드라고 한다. Pipe는 circular buffer로서, producer와 consumer thread만 접근 가능한 - 둘 사이에 공유된 - 자원이다. 앞서 Thread Safety 부분에서 언급한 것처럼 한 개의 스레드만 데이터를 조작하고, 나머지 하나의 스레드는 읽기만 하므로 Pipe를 사용하는 것은 Thread Safe한 방법이다.</p>\n<p>Pipe는 여러 개의 task를 decouple하기 위한 용도로 많이 쓰이며, 두 개의 long-running task가 있을 경우 한 개의 task가 끝난 후 다음 task가 새로운 스레드에서 실행될 수 있게 해 준다. Pipe는 <code class=\"language-text\">PipedInputStream</code>, <code class=\"language-text\">PipedOuputStream</code>을 통해 binary나 character data를 전달할 수 있게 해 주는데, connection이 형성될 때부터 닫힐 때까지 작동한다. 이 과정을 크게 세 가지로 나누면 setup, data transfer, disconnection으로, 간단한 예시를 보자.</p>\n<ul>\n<li>Set up</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">PipedInputStream</span> pipedInputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PipedInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">PipedOutputStream</span> pipedOutputStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PipedOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npipedInputStream<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>pipedInputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>Data transfer</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Thread</span> inputThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> string <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello Pipe!\"</span><span class=\"token punctuation\">;</span>\n            pipedOutputStream<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Thread</span> outputThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">int</span> data <span class=\"token operator\">=</span> pipedInputStream<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> data <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> data <span class=\"token operator\">=</span> pipedInputStream<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">IOException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ninputThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\noutputThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 코드에서 <code class=\"language-text\">PipedInputStream.read()</code>와 <code class=\"language-text\">PipedOutputStream.write()</code>는 blocking call이기 때문에 같은 스레드에서 동시에 read와 write를 하면 deadlock 상태가 되는 것에 주의하라.</p>\n<ul>\n<li>Disconnection</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">pipedInputStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\npipedOutputStream<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그렇다면 Android에서 이를 적용시키려면 어떻게 해야 할까? 간단한 예시로 액티비티를 실행하는 동안 어떤 이벤트가 발생하면 worker thread에서 처리하는 상황을 생각해 보자. <code class=\"language-text\">onCreate()</code>시에 위의 <code class=\"language-text\">PipedInputStream</code>과 <code class=\"language-text\">PipedOutputStream</code>을 생성 후 연결시켜 주고, worker thread에서 무한 루프를 돌며 <code class=\"language-text\">PipedInputStream</code>에 data가 있는지 계속 확인하도록 만든다. 이벤트 발생 시에 main thread에서 <code class=\"language-text\">PipedOutputStream</code>에 <code class=\"language-text\">write()</code>를 하도록 하면 Pipe가 비어 있지 않으므로 worker thread에서 data를 받아 처리하게 된다. 이 때 <code class=\"language-text\">onDestroy()</code>에서 stream들을 <code class=\"language-text\">close()</code>하고 worker thread를 <code class=\"language-text\">inturrupt()</code>해야 메모리 낭비가 생기지 않는다. 또한 pipe가 가득 차면 UI thread를 blocking 하게 되므로 buffer size를 충분하게 설정해야 한다.</p>\n<p>(TODO sample code 추가할 것)</p>\n<h4>3.2. Shared Memory</h4>\n<p>[그림]</p>\n<p>스레드의 특징 중 하나는 한 프로세스 내의 모든 스레드는 각각의 stack 영역을 제외하고는 다른 모든 부분 - Code, Data, Heap 영역을 공유한다는 것이다. 이 Heap 영역을 이용하여 스레드간의 통신을 할 수 있다. Java에서 모든 객체는 Heap 영역에 저장되며, 이 객체들의 reference들은 각각 thread의 stack에 저장된다. 따라서 이 reference만 thread간에 전달해 주면 전달받은 thread는 전달받은 reference가 가리키는 객체에 접근할 수 있게 된다.</p>\n<p>만일 두 스레드가 순서대로 실행되야 하며, 두 스레드 간에 Shared Memory를 사용해 통신한다면 어떻게 해야 할까? 앞서 Pipe의 예시처럼 어떤 state를 polling하여 구현할 수 있다. Shared Memory에 state를 나타내는 변수를 만들고, 무한 루프를 돌며 state 변수가 변하는 것을 체크하는 것이다. 이 방법도 물론 잘 동작하지만, 이러한 busy waiting은 성능 저하를 초래한다. Java의 built-in signaling mechanism을 이용하면 더 효율적으로 작동하게 할 수 있는데, <code class=\"language-text\">java.lang.Object</code>에 정의되어 있는 <code class=\"language-text\">wait()</code>, <code class=\"language-text\">notify()</code>, <code class=\"language-text\">notifyAll()</code> 세 개의 메서드를 사용하는 것이다. 간단하게 예시 코드를 통해 사용법을 소개하고 넘어가겠다. 더 자세한 설명은 <a href=\"http://tutorials.jenkov.com/java-concurrency/thread-signaling.html\">이 포스트</a>를 참고하라.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">WaitNotify</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Object</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> wasSignalled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doWait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>wasSignalled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                lock<span class=\"token punctuation\">.</span><span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        wasSignalled <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doNotify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span>lock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            wasSignalled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            lock<span class=\"token punctuation\">.</span><span class=\"token function\">notify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Thread</span> threadA <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadA: run() called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadA: 0.\"</span> <span class=\"token operator\">+</span> i <span class=\"token operator\">+</span> <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token function\">doNotify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Thread</span> threadB <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Runnable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadB: run() called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token function\">doWait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadB: start working\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        threadA<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        threadB<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">doNotify()</code> 함수가 실행되기 전까지는 <code class=\"language-text\">wasSignalled</code>의 값이 <code class=\"language-text\">false</code>이므로 <code class=\"language-text\">doWait()</code>함수에서 <code class=\"language-text\">lock.wait()</code>을 실행하게 된다. <code class=\"language-text\">lock</code> Object에 대해 synchronized 된 블럭 안에 있는 코드는 <code class=\"language-text\">lock</code>객체에 대한 Lock을 획득하기 전까지는 비활성화된다. <code class=\"language-text\">threadA</code>가 시작된지 0.5초가 지나 <code class=\"language-text\">doNotify()</code>가 호출되면 <code class=\"language-text\">lock</code> 객체의 Lock을 반환하고, 그제서야 threadB의 <code class=\"language-text\">doWait();</code>을 벗어나 다음 코드로 넘어가게 된다.</p>\n<p>다른 방법으로는 <code class=\"language-text\">java.util.concurrent.CountDownLatch</code>를 사용하는 방법이 있다. <code class=\"language-text\">CountDownLatch.await()</code>, <code class=\"language-text\">CountDownLatch.countDown()</code> 메서드를 사용하는 방법으로, <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CountDownLatch.html\">공식 API 문서</a>에 예제 코드까지 자세하게 나와 있으니 자세한 설명은 생략하도록 하겠다.</p>\n<h4>3.3. Blocking Queue</h4>\n<p>위에서 살펴본 thread signal을 사용하는 방법은 low-level mechansim이기 때문에 use case에 따라 많은 부분을 직접 설정해 사용할 수 있다. 하지만 그만큼 고려해야 할 사항이 많고, 에러를 일으키기 쉽다는 단점이 있기 때문에 Java에서는 단방향 통신에 대해 추상화된 high-level signaling mechansim을 제공한다.</p>\n<p>[그림]</p>\n<p><code class=\"language-text\">java.util.concurrent.BlockingQueue</code> 인터페이스들의 구현체로는 여러 가지가 있는데, Array로 구현되어 고정 크기를 가지는 <code class=\"language-text\">ArrayBlockingQueue</code>, Linked List로 구현된 <code class=\"language-text\">LinkedBlockingQueue</code>, Priority를 가지는 <code class=\"language-text\">PriorityBlockingQueue</code>, insert와 remove가 동시에 이루어지는, 크기가 항상 0으로 유지되는 <code class=\"language-text\">SynchronousQueue</code> 등이 있다. <a href=\"http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/BlockingQueue.html\">공식 API 문서</a>의 예제 코드를 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Producer</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">BlockingQueue</span> queue<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Producer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BlockingQueue</span> q<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> queue <span class=\"token operator\">=</span> q<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> handle <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token class-name\">Object</span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Consumer</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Runnable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">BlockingQueue</span> queue<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Consumer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BlockingQueue</span> q<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> queue <span class=\"token operator\">=</span> q<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">consume</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> handle <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">consume</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Setup</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">BlockingQueue</span> q <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SomeQueueImplementation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Producer</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Producer</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Consumer</span> c1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Consumer</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Consumer</span> c2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Consumer</span><span class=\"token punctuation\">(</span>q<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>c1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span>c2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Producer는 <code class=\"language-text\">BlockingQueue.put()</code>을 하고, Consumer는 <code class=\"language-text\">BlockingQueue.take()</code>를 하는 것만으로 Thread Safe한 통신을 구현할 수 있다. 내부적으로 atomical하게 작동하도록 lock을 컨트롤 해 주기 때문이다.</p>\n<h3>4. Thread Communication in Android</h3>\n<p>지금까지 Java의 Thread Communication 방법들에 대해 알아보았다. 앞서 언급한 모든 방법은 Android에서도 같은 방법으로 사용할 수 있으나, 모두 UI 스레드를 block하는 상황 - Queue가 가득 차거나 하는 - 이 발생할 위험이 있다. UI Thread가 block되면 반응성이 저하되고 ANR이 발생 위험이 있으므로, 이 문제를 해결하기 위해서는 nonblocking한 consumer-producer pattern이 필요하다. Android platform에서는 자체적으로 message handling mechanism을 만들어 <code class=\"language-text\">android.os</code> 패키지에서 제공하고 있다.</p>\n<h4>4.1. Android Message Handling Mechanism</h4>\n<p>[그림]</p>\n<p>안드로이드에서 message handling은 <code class=\"language-text\">android.os.Looper</code>, <code class=\"language-text\">android.os.Handler</code>, <code class=\"language-text\">android.os.MessageQueue</code>, <code class=\"language-text\">android.os.Message</code> 네 가지를 이용해 이루어진다. <code class=\"language-text\">Looper</code>는 message dispatcher로서, 하나의 consumer thread에서 작동한다. <code class=\"language-text\">Handler</code>의 경우 consumer thread의 message processor이자, producer thread가 <code class=\"language-text\">Message</code>를 queue에 넣을 수 있도록 하는 interface 역할을 한다. <code class=\"language-text\">MessageQueue</code>는 크기제한이 없는 Linked List로서, <code class=\"language-text\">Looper</code>에서 dispatch된 <code class=\"language-text\">Message</code>들이 <code class=\"language-text\">Handler</code>를 통해 추가된다. <code class=\"language-text\">Message</code>란 말 그대로 임의의 데이터나 객체를 담는 객체로, consumer thread에서 실행될 것을 담아 보낼 수 있다.</p>\n<p>message handling이 이루어지는 과정은 크게 세 부분 - Insert, Retrieve, Dispatch - 으로 이루어진다. 먼저 producer thread가 consumer thread에 연결되어 있는 <code class=\"language-text\">Handler</code>에 <code class=\"language-text\">Message</code>를 insert한다. 한편, consumer thread에서 작동하는 <code class=\"language-text\">Looper</code>는 <code class=\"language-text\">MessageQueue</code>의 <code class=\"language-text\">Message</code>들을 순차적으로 Retrieve한다. Retrieve된 <code class=\"language-text\">Message</code>는 <code class=\"language-text\">Looper</code>에 의해 알맞은 <code class=\"language-text\">Handler</code>로 Dispatch되고, <code class=\"language-text\">Handler</code>에 의해 처리된다.</p>\n<p>각각의 클래스들에 대해 더 살펴보기 전에 <code class=\"language-text\">android.os.Looper</code>의 소스 코드에 주석으로 나와 있는 샘플 코드를 간단히 보고 넘어가자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LooperThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span> mHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// process incoming messages here</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>4.2. MessageQueue</h4>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/MessageQueue.java\">platform<em>frameworks</em>base/core/java/android/os/MessageQueue.java</a></p>\n<p><code class=\"language-text\">android.os.MessageQueue</code>에 정의된 메시지큐는 단방향 Linked List로 구현되어 있는데, Producer thread가 insert한 <code class=\"language-text\">Message</code>가 차례대로 dispatch되어 consumer thread에 전달된다. insert된 <code class=\"language-text\">Message</code>들은 timestamp에 따라 정렬되며 timestamp를 queue 첫 번째의 timestamp보다 작은 값을 주는 식으로 queue의 첫 번째로 새로운 <code class=\"language-text\">Message</code>를 삽입할 수 있다. <code class=\"language-text\">Message</code>의 timestamp가 현재 시간보다 미래라면 dispatch 하지 않고 기다리는데, Dispatch Barrier를 - 멤버 <code class=\"language-text\">mNextBarrierToken</code>를 이용해 구현됨 - 넘어온 <code class=\"language-text\">Message</code>가 없다면 consumer thread를 block하게 되고, 넘어온 것이 생기면 다시 실행된다. 이렇게 block되는 시간동안 <code class=\"language-text\">MessageQueue.IdleHandler</code>를 사용하면 다른 작업을 처리할 수 있는데, 만약 idle time 없이 어떤 작업들이 수행되는 consumer thread의 MessageQueue라면 <code class=\"language-text\">Looper.quit()</code>를 통해 스레드를 종료하고 메모리를 반환할 수 있다. 단, UI thread의 <code class=\"language-text\">Looper</code>는 정지시킬 수 없다. <code class=\"language-text\">IdleHandler</code>는 <code class=\"language-text\">boolean queueIdle()</code> 하나의 메서드만을 가지는 인터페이스인데, true를 반환할 경우 계속 <code class=\"language-text\">IdleHandler</code>를 active한 상태로 두고, false를 반환할 경우 지금 설정되어 있는 <code class=\"language-text\">IdleHandler</code>를 제거한다. 처음 스레드가 만들어졌을 때의 idle time을 건너뛰고 다음 idle time에 thread를 제거하는 Thread 내부 코드를 간단히 소개하고 넘어가겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> mIsFirstIdle <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">myQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addIdleHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Override</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">queueIdle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mIsFirstIdle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mIsFirstIdle <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    mConsumerHandler<span class=\"token punctuation\">.</span><span class=\"token function\">getLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">quit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>(Remove, Add, Observe 등 Method 추가할 것)</p>\n<h4>4.3. Message</h4>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/Message.java\">platform<em>frameworks</em>base/core/java/android/os/Message.java</a></p>\n<p><code class=\"language-text\">android.os.Message</code> 클래스는 container object로서, data item이나 task를 전달하는데 사용된다. <code class=\"language-text\">Message</code>의 파라미터로는 여러 가지가 있는데, 정리하면 다음과 같다.</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Name</th>\n<th align=\"center\">Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><code class=\"language-text\">what</code></td>\n<td align=\"center\"><code class=\"language-text\">int</code></td>\n<td>Message identifier</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">arg1</code>, <code class=\"language-text\">arg2</code></td>\n<td align=\"center\"><code class=\"language-text\">int</code></td>\n<td>Simple integer data values</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">obj</code></td>\n<td align=\"center\"><code class=\"language-text\">Object</code></td>\n<td>Arbitrary objcet. If it is handed off to another process, it has to implement <code class=\"language-text\">Parcelable</code></td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">data</code></td>\n<td align=\"center\"><code class=\"language-text\">Bundle</code></td>\n<td>Container of arbitrary data values</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">replyTo</code></td>\n<td align=\"center\"><code class=\"language-text\">Messenger</code></td>\n<td>Reference to <code class=\"language-text\">Handler</code> in other process. Enables 2-Way IPC</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">callback</code></td>\n<td align=\"center\"><code class=\"language-text\">Runnable</code></td>\n<td>Task to execute on a thread. Internal instance field holds the <code class=\"language-text\">Runnable</code> object from <code class=\"language-text\">Handler.post()</code></td>\n</tr>\n</tbody>\n</table>\n<p>이 때 우리가 흔히 Task라고 부르는 <code class=\"language-text\">Runnable</code> 객체인 <code class=\"language-text\">callback</code>을 가지는 <code class=\"language-text\">Message</code>는 다른 모든 데이터를 가질 수 없다는 것에 주의하라. <code class=\"language-text\">MessageQueue</code>는 Task를 전달하는 <code class=\"language-text\">Message</code>와 data를 전달하는 <code class=\"language-text\">Message</code> 모두 가질 수 있다. 타입에 상관없이 모든 <code class=\"language-text\">Message</code>들은 순서대로 실행되는데, Task message는 <code class=\"language-text\">Handler.handleMessage(Message)</code>에서 아무 메시지도 받을 수 없다.</p>\n<p><code class=\"language-text\">Message</code>의 lifecycle은 아주 간단한데, 먼저 producer thread에서 생성되고 초기화된다. 이 과정에서 생성자를 이용해 만들기도 하지만, 보통 Factory method들을 사용해 만든다. 각각 만드려는 메서드에 따라 사용하는 메서드는 다음과 같다.</p>\n<ul>\n<li>빈 메시지를 만들 때\n<code class=\"language-text\">Message.obtain()</code></li>\n<li>Data 메시지를 만들 때\n<code class=\"language-text\">Message.obtain(Handler h, SomeData data)</code></li>\n<li>Task 메시지를 만들 때\n<code class=\"language-text\">Message.obtain(Handler h, Runnable task)</code></li>\n</ul>\n<p>이렇게 초기화된 메시지는 <code class=\"language-text\">MessageQueue</code>에 enqueue되고, consumer thread로 dispatch될 때까지 Pending 상태가 된다. <code class=\"language-text\">Looper</code>는 루프를 돌며 큐의 메시지들을 차례로 dispatch 시키는데, dispatch된 메시지들은 consumer thread에서 실행된다. 이후 <code class=\"language-text\">Message</code> 인스턴스는 Android Runtime에 의해 message pool로 반환되어 재사용된다.</p>\n<h4>4.4. Looper</h4>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/Looper.java\">platform<em>frameworks</em>base/core/java/android/os/Looper.java</a></p>\n<p><code class=\"language-text\">android.os.Looper</code> 클래스는 <code class=\"language-text\">MessageQueue</code>의 <code class=\"language-text\">Message</code>들을 dispatch 시켜 알맞은 <code class=\"language-text\">Handler</code>로 연결해 준다. 한 스레드는 하나의 <code class=\"language-text\">Looper</code>만 가질 수 있고, UI thread는 기본적으로 <code class=\"language-text\">Looper</code>를 가지고 있다. <code class=\"language-text\">Looper</code>가 생성되고 준비되는 과정을 잠시 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> quitAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mQueue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessageQueue</span><span class=\"token punctuation\">(</span>quitAllowed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    mThread <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentThread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">></span></span> sThreadLocal <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThreadLocal</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageQueue</span> mQueue<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">Thread</span> mThread<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> quitAllowed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sThreadLocal<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Only one Looper may be created per thread\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    sThreadLocal<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">(</span>quitAllowed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>보다시피 <code class=\"language-text\">prepare()</code>에서는 스레드 로컬 메모리에 <code class=\"language-text\">Looper</code>를 생성해 set한다. <code class=\"language-text\">Looper</code>는 생성될 때 새로운 <code class=\"language-text\">MessageQueue</code>를 생성하고, 생성자가 실행되고 있는 스레드를 저장한다. 위에서 소개한 간단한 예제에서처럼 별다른 코드 없이 간단하게 <code class=\"language-text\">LooperThread</code>를 만들 수 있게 static method로서 thread와 <code class=\"language-text\">Looper</code>를 연결시켜 준 것이다.</p>\n<p>이제, 핸들러에 대한 부분은 잠시 미뤄두고, <code class=\"language-text\">Looper.loop()</code> 메서드에 대해 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">Looper</span> me <span class=\"token operator\">=</span> <span class=\"token function\">myLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>me <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No Looper; Looper.prepare() wasn't called on this thread.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageQueue</span> queue <span class=\"token operator\">=</span> me<span class=\"token punctuation\">.</span>mQueue<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Make sure the identity of this thread is that of the local process,</span>\n    <span class=\"token comment\">// and keep track of what that identity token actually is.</span>\n    <span class=\"token class-name\">Binder</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearCallingIdentity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> ident <span class=\"token operator\">=</span> <span class=\"token class-name\">Binder</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearCallingIdentity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Message</span> msg <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// might block</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msg <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// No message indicates that the message queue is quitting.</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// This must be in a local variable, in case a UI event sets the logger</span>\n        <span class=\"token class-name\">Printer</span> logging <span class=\"token operator\">=</span> me<span class=\"token punctuation\">.</span>mLogging<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logging <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            logging<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\">>>>> Dispatching to \"</span> <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>target <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">+</span>\n                    msg<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">+</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>what<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        msg<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchMessage</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>logging <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            logging<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;&lt;&lt;&lt;&lt; Finished to \"</span> <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>target <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span> <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Make sure that during the course of dispatching the</span>\n        <span class=\"token comment\">// identity of the thread wasn't corrupted.</span>\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> newIdent <span class=\"token operator\">=</span> <span class=\"token class-name\">Binder</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearCallingIdentity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ident <span class=\"token operator\">!=</span> newIdent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">wtf</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Thread identity changed from 0x\"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>ident<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" to 0x\"</span>\n                    <span class=\"token operator\">+</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>newIdent<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" while dispatching to \"</span>\n                    <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\" \"</span>\n                    <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">+</span> <span class=\"token string\">\" what=\"</span> <span class=\"token operator\">+</span> msg<span class=\"token punctuation\">.</span>what<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        msg<span class=\"token punctuation\">.</span><span class=\"token function\">recycleUnchecked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Looper</code>는 말 그대로 <code class=\"language-text\">for(;;)</code>를 통해 무한 루프를 돌며 다음 <code class=\"language-text\">Message</code>를 <code class=\"language-text\">msg.target.dispatchMessage(msg)</code>한다. 이 때 <code class=\"language-text\">Message msg = queue.next()</code>을 통해 <code class=\"language-text\">MessageQueue</code>에서 <code class=\"language-text\">Message</code>를 가져오는데, dispatch barrier를 통과한 <code class=\"language-text\">Message</code>가 없다면 이 부분에서 blocking이 일어나 기다리게 된다.</p>\n<p>Looper를 제거하는 것은 간단한데, <code class=\"language-text\">quit()</code> 메서드를 호출하면 dispatch barrier를 통과한 <code class=\"language-text\">Message</code>를 포함, <code class=\"language-text\">MessageQueue</code>의 모든 pending 메시지를 삭제한다. 이 때 <code class=\"language-text\">quit()</code> 대신 API level 18부터 추가된 <code class=\"language-text\">quitSafely()</code> 메서드를 이용하면 dispatch barrier를 통과하지 못한 메시지만 삭제할 수 있다. <code class=\"language-text\">Looper</code>를 제거한다고 thread가 제거되는 것은 아니다. 그러나 <code class=\"language-text\">Looper.loop()</code>를 통해 실행되던 무한루프가 멈춤으로서 그 스레드에서 더 이상의 작업이 없으면 자연스럽게 제거될 것이다. 주의해야 할 것은 <code class=\"language-text\">quit()</code>한 후 다시 <code class=\"language-text\">Looper.prepare()</code>를 할 경우 <code class=\"language-text\">RuntimeException</code>이 발생하고, <code class=\"language-text\">Looper.loop()</code>를 할 경우 메시지가 dispatch되지 않아 thread가 block되게 된다.</p>\n<p>UI Thread의 경우 Main Thread인 만큼 Looper도 특이한데, <code class=\"language-text\">private static Looper sMainLooper</code>에서 알 수 있듯 static한 Looper이다. 어디서든 <code class=\"language-text\">Looper.getMainLooper()</code>를 통해 접근할 수 있으며, 새로 <code class=\"language-text\">prepare()</code> 되거나 <code class=\"language-text\">quit()</code> 될 수 없다.</p>\n<h4>4.5. Handler</h4>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/Handler.java\">platform<em>frameworks</em>base/core/java/android/os/Handler.java</a></p>\n<p>앞서 <code class=\"language-text\">MessageQueue</code>, <code class=\"language-text\">Message</code>, <code class=\"language-text\">Looper</code>를 설명하면서 빠지지 않고 등장한 <code class=\"language-text\">android.os.Handler</code>는 Android Thread Communication에서 핵심적인 역할을 하는 클래스이다. <code class=\"language-text\">Handler</code>는 insertion과 processing 두 가지를 모두 담당하는데, 항상 특정 스레드와 연결되어 있어야 하고, 해당 스레드에는 메시지를 담을 수 있는 <code class=\"language-text\">MessageQueue</code>와 메시지를 전달해줄 Looper가 있어야 한다.\n<code class=\"language-text\">Handler</code>의 생성자를 호출하기 전 <code class=\"language-text\">Looper.prepare()</code> 메서드를 통해 <code class=\"language-text\">MessageQueue</code>와 <code class=\"language-text\">Looper</code>를 만들어 주지 않은 채 핸들러를 생성하려 하면 <code class=\"language-text\">RuntimeException</code>을 내며 에러가 난다. <code class=\"language-text\">Handler</code> 생성자들의 코드를 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Callback</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> async<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Callback</span> callback<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>FIND_POTENTIAL_LEAKS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">final</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">></span></span> klass <span class=\"token operator\">=</span> <span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>klass<span class=\"token punctuation\">.</span><span class=\"token function\">isAnonymousClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> klass<span class=\"token punctuation\">.</span><span class=\"token function\">isMemberClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> klass<span class=\"token punctuation\">.</span><span class=\"token function\">isLocalClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n                <span class=\"token punctuation\">(</span>klass<span class=\"token punctuation\">.</span><span class=\"token function\">getModifiers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">Modifier</span><span class=\"token punctuation\">.</span>STATIC<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">Log</span><span class=\"token punctuation\">.</span><span class=\"token function\">w</span><span class=\"token punctuation\">(</span>TAG<span class=\"token punctuation\">,</span> <span class=\"token string\">\"The following Handler class should be static or leaks might occur: \"</span> <span class=\"token operator\">+</span>\n                klass<span class=\"token punctuation\">.</span><span class=\"token function\">getCanonicalName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    mLooper <span class=\"token operator\">=</span> <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">myLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mLooper <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"Can't create handler inside thread that has not called Looper.prepare()\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    mQueue <span class=\"token operator\">=</span> mLooper<span class=\"token punctuation\">.</span>mQueue<span class=\"token punctuation\">;</span>\n    mCallback <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n    mAsynchronous <span class=\"token operator\">=</span> async<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Looper</code>를 인자로 받는 생성자가 아닌 경우, 실행되고 있는 스레드의 루퍼를 가져온다. 만약 스레드에 루퍼가 생성되어 있지 않다면 <code class=\"language-text\">RuntimeException</code>을 띄우는 것을 볼 수 있다. 이러한 경우는 생성자 호출 전에 <code class=\"language-text\">Looper.prepare()</code>를 호출해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span> looper<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span> looper<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Callback</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span> looper<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Callback</span> callback<span class=\"token punctuation\">,</span> <span class=\"token keyword\">boolean</span> async<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mLooper <span class=\"token operator\">=</span> looper<span class=\"token punctuation\">;</span>\n    mQueue <span class=\"token operator\">=</span> looper<span class=\"token punctuation\">.</span>mQueue<span class=\"token punctuation\">;</span>\n    mCallback <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n    mAsynchronous <span class=\"token operator\">=</span> async<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Looper</code>를 명시적으로 넘기는 경우 특정 <code class=\"language-text\">Looper</code>와 결합시킬 수 있다. 모든 생성자는 생성시에 <code class=\"language-text\">Looper</code>와 <code class=\"language-text\">Looper</code>가 갖고 있는 <code class=\"language-text\">MessageQueue</code>와 결합되므로 <code class=\"language-text\">Handler</code> 생성 전에 <code class=\"language-text\">Looper</code> 생성이 필요하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">final</span> <span class=\"token class-name\">MessageQueue</span> mQueue<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">final</span> <span class=\"token class-name\">Looper</span> mLooper<span class=\"token punctuation\">;</span></code></pre></div>\n<p>하나의 스레드는 하나의 <code class=\"language-text\">Looper</code>와 <code class=\"language-text\">MessageQueue</code>만 가질 수 있다고 이야기했다. 위의 <code class=\"language-text\">Looper</code>에서 멤버 선언 코드의 <code class=\"language-text\">final</code>을 주목하라. 하지만 <code class=\"language-text\">Handler</code>의 개수엔 제한이 없다. 한 스레드 위에 여러 개의 <code class=\"language-text\">Handler</code>가 존재하는 경우 모두 하나의 <code class=\"language-text\">Looper</code>와 상호작용하며, <code class=\"language-text\">MessageQueue</code>에 들어온 순서에 따라 순차적으로 실행된다. 그러나 <code class=\"language-text\">Handler</code> 역시 <code class=\"language-text\">MessageQueue</code>와 <code class=\"language-text\">Looper</code>는 <code class=\"language-text\">final</code>로 선언되어 있으며, Binding이 이루어진 후에는 다른 <code class=\"language-text\">Looper</code>에 결합될 수 없다.</p>\n<p><code class=\"language-text\">boolean async</code> 부분은 Message.setAsynchronous()를 하기 위해 <code class=\"language-text\">mAsynchronous</code>에 저장하는 파라미터로, 자세한 설명은 <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/Message.java\">공식 소스코드</a>의 주석을 인용한다.</p>\n<blockquote>\n<p>Sets whether the message is asynchronous, meaning that it is not\nsubject to {@link Looper} synchronization barriers.</p>\n<p>Certain operations, such as view invalidation, may introduce synchronization barriers into the {@link Looper}‘s message queue to prevent subsequent messages from being delivered until some condition is met. In the case of view invalidation, messages which are posted after a call to {@link android.view.View#invalidate} are suspended by means of a synchronization barrier until the next frame is ready to be drawn. The synchronization barrier ensures that the invalidation request is completely handled before resuming.</p>\n<p>Asynchronous messages are exempt from synchronization barriers. They typically represent interrupts, input events, and other signals that must be handled independently even while other work has been suspended.</p>\n<p>Note that asynchronous messages may be delivered out of order with respect to synchronous messages although they are always delivered in order among themselves. If the relative order of these messages matters then they probably should not be asynchronous in the first place. Use with caution.</p>\n</blockquote>\n<p><code class=\"language-text\">Handler</code>는 위에서 살펴본 <code class=\"language-text\">Message</code> 클래스의 메서드들에 대한 wrapper 메서드들을 가지고 있는데, <code class=\"language-text\">Message</code> 생성에 대한 메서드들을 먼저 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> what<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> what<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> what<span class=\"token punctuation\">,</span> arg1<span class=\"token punctuation\">,</span> arg2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">obtainMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> arg2<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> what<span class=\"token punctuation\">,</span> arg1<span class=\"token punctuation\">,</span> arg2<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 wrapper 메서드들을 통해 <code class=\"language-text\">Message</code>들은 message pool로부터 <code class=\"language-text\">Handler</code>로 obtain되며, 이와 동시에 불러온 <code class=\"language-text\">Handler</code>와 결합된다. 하지만 이렇게 결합되었다고 해서 <code class=\"language-text\">MessageQueue</code>로 들어가는 것은 아니다. <code class=\"language-text\">Message</code>를 <code class=\"language-text\">MessageQueue</code>에 넣으려면 <code class=\"language-text\">send()</code> 메서드를 호출해야 한다. 자세한 API는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">boolean</span> <span class=\"token function\">sendMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">sendMessageAtFrontOfQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">sendMessageAtTime</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> uptimeMillis<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">sendMessageDelayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> delayMillis<span class=\"token punctuation\">)</span></code></pre></div>\n<p>간단하게 integer data를 <code class=\"language-text\">MessageQueue</code>에 넣기 위해 빈 <code class=\"language-text\">Message</code>를 <code class=\"language-text\">obtain()</code>해서 <code class=\"language-text\">what</code> 부분에 넣어 보내는 메서드도 제공된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">boolean</span> <span class=\"token function\">sendEmptyMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">sendEmptyMessageAtTime</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> uptimeMillis<span class=\"token punctuation\">)</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">sendEmptyMessageDelayed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> delayMillis<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Task - <code class=\"language-text\">Runnable</code> - 를 간단하게 보낼 수 있는 메서드 역시 제공된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">boolean</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">postAtFrontOfQueue</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">postAtTime</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> token<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> uptimeMillis<span class=\"token punctuation\">)</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">postAtTime</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> uptimeMillis<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">boolean</span> <span class=\"token function\">postDelayed</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> delayMillis<span class=\"token punctuation\">)</span></code></pre></div>\n<p>간단히 <code class=\"language-text\">post(Runnable r)</code>의 코드를 살펴보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">sendMessageDelayed</span><span class=\"token punctuation\">(</span><span class=\"token function\">getPostMessage</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Message</span> <span class=\"token function\">getPostMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Message</span> m <span class=\"token operator\">=</span> <span class=\"token class-name\">Message</span><span class=\"token punctuation\">.</span><span class=\"token function\">obtain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    m<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> r<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> m<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>파라미터로 받은 <code class=\"language-text\">Runnable</code>은 새로운 <code class=\"language-text\">Message</code>의 <code class=\"language-text\">callback</code>에 저장되어 <code class=\"language-text\">enqueueMessage(queue, msg, uptimeMillis)</code> 메서드에 의해 메시지큐에 들어가게 된다.</p>\n<p>메서드 <code class=\"language-text\">postAtTime(Runnable r, Object token, long uptimeMillis)</code>의 <code class=\"language-text\">Object token</code>은 소스코드에도 구글 개발자 문서에도 명확한 설명이 없다. 코드상으로 보면 <code class=\"language-text\">Message.obj</code>에 token을 저장하는데, 메시지를 제거할 때 <code class=\"language-text\">token</code>을 가진 콜백만을 제거하는 데 사용되는 것으로 추정된다.</p>\n<p><code class=\"language-text\">Handler</code>는 <code class=\"language-text\">Message</code> 제거에 대한 <code class=\"language-text\">MessageQueue</code> 메서드들의 wrapper 메서드도 가지고 있다. <code class=\"language-text\">Message</code>의 callback인 <code class=\"language-text\">Runnable</code>, <code class=\"language-text\">Object token</code>, <code class=\"language-text\">int what</code> 등을 가지고 <code class=\"language-text\">MessageQueue.removeMessages()</code>를 호출하는 것이다. <code class=\"language-text\">Message</code> 제거에 대한 API는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">removeCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">)</span>\n<span class=\"token function\">removeCallbacks</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Runnable</span> r<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> token<span class=\"token punctuation\">)</span>\n<span class=\"token function\">removeMessages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">)</span>\n<span class=\"token function\">removeMessages</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> what<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> object<span class=\"token punctuation\">)</span>\n<span class=\"token function\">removeCallbacksAndMessages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> token<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">MessageQueue</code>에 들어간 <code class=\"language-text\">Message</code>는 <code class=\"language-text\">Looper</code>에 의해 Consumer thread로 dispatch 되는데, 이 부분의 코드를 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">dispatchMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCallback <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mCallback<span class=\"token punctuation\">.</span><span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleCallback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Callback</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">dispatchMessage(Message msg)</code>는 <code class=\"language-text\">Looper</code>의 루프에서 자동으로 실행되는 - 위의 <code class=\"language-text\">Looper.loop()</code> 코드 중 <code class=\"language-text\">msg.target.dispatchMessage(msg)</code> 부분을 참고하라 - 메서드로서, 처리하는 <code class=\"language-text\">Message</code>의 <code class=\"language-text\">callback</code>의 존재 여부 - Task Message인지, Data Message인지 여부 - 에 따라 실행하는 방법이 다르다. Task Message의 경우 <code class=\"language-text\">handleCallback(msg)</code>을 실행하는데, 최종적으로 <code class=\"language-text\">msg.callback.run()</code>을 실행한다. <code class=\"language-text\">callback</code>만 가지는 <code class=\"language-text\">Message</code>를 <code class=\"language-text\">MessageQueue</code>에 넣어주기만 하면 들어간 순서에 따라 <code class=\"language-text\">callback</code>이 실행되는 것이다. 앞서 <code class=\"language-text\">callback</code>을 가지는 <code class=\"language-text\">Message</code>는 다른 data값을 가질 수 없다고 했는데, 더 정확하게는 <code class=\"language-text\">callback</code>을 가지고 있는 경우 data를 처리하는 코드를 건너 뛰어 data가 있더라도 사용할 방법이 없는 것이다.</p>\n<p>Data Message의 경우 <code class=\"language-text\">mCallback</code>이 있다면 <code class=\"language-text\">Handler.mCallback.handleMessage(msg)</code>를 실행, 없다면 건너뛰고 최종적으로 <code class=\"language-text\">Handler.handleMessage(msg)</code>를 호출한다. 이 때 <code class=\"language-text\">mCallback.handleMessage(msg)</code>의 반환값이 <code class=\"language-text\">true</code>일 경우 <code class=\"language-text\">Handler.handleMessage(msg)</code>는 실행되지 않는다. 즉, Data Message의 처리는 <code class=\"language-text\">Handler.handleMessage(msg)</code>를 오버라이딩하는 것과 <code class=\"language-text\">Callback</code> 인터페이스 - <code class=\"language-text\">Callback.handleMessage(msg)</code> - 를 구현한 것을 <code class=\"language-text\">Handler.mCallback</code>에 넣는 두 가지 방법이 있다. 이에 대한 예시를 살펴보자.</p>\n<ul>\n<li><code class=\"language-text\">Handler.handleMessage(Message msg)</code> 사용</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LooperThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span> mHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// process incoming messages here</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">Handler.Callback.handleMessage(Message msg)</code> 사용</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HandleMessageActivity</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Activity</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Callback</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Handler</span> mUIHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mUiHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// process incoming messages here</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>두 가지 방법을 동시에 사용할 경우 주의해야 할 것은 <code class=\"language-text\">Callback.handleMessage()</code>가 먼저 실행된다는 것이다. 또한 이 메서드의 반환값에 따라 - <code class=\"language-text\">true</code>일 경우 - <code class=\"language-text\">Handler.handleMessage()</code>는 실행되지 않는다는 것에 유의해야 한다.</p>\n<p>(TODO Observing MessageQueue)\nCommunicating with the UI thread\nrunonui code</p>\n<h3>5. HandlerThread</h3>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/HandlerThread.java\">platform<em>frameworks</em>base/core/java/android/os/HandlerThread.java</a></p>\n<p>앞서 <code class=\"language-text\">Handler</code>를 이용한 Android Message Passing Mechansim에 대해 이야기했다. <code class=\"language-text\">android.os.HandlerThread</code>는 <code class=\"language-text\">Handler</code>를 조금 더 간편하게 사용할 수 있도록 해 주는 클래스이며, 일반적인 <code class=\"language-text\">Thread</code>와 같은 방식으로 사용하면 내부적으로 <code class=\"language-text\">Looper</code>와 <code class=\"language-text\">MessageQueue</code>를 세팅해 주는 것이다.</p>\n<h4>5.1. Basis</h4>\n<p>안드로이드 core 개발자들은 주석에서 <code class=\"language-text\">HandlerThread</code>를 <em>Handy class for starting a new thread that has a looper.</em>이라 소개하고 있다. 말 그대로 <code class=\"language-text\">HandlerThread</code>는 <code class=\"language-text\">Looper</code>에 대해 생각할 필요 없이 <code class=\"language-text\">Handler</code>를 사용할 수 있게 해주는 클래스라고 보면 된다. 간단하게 사용하는 방법을 소개한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">HandlerThread</span> handlerThread <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HandlerThread</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"HandlerThread\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> handlerThread<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span>handlerThread<span class=\"token punctuation\">.</span><span class=\"token function\">getLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Process incoming messages here</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">HandlerThread</code>를 생성한 후, <code class=\"language-text\">HandlerThread</code>의 <code class=\"language-text\">Looper</code>를 인자로 넘겨 새로운 <code class=\"language-text\">Handler</code>를 만들면 된다. 앞서 <code class=\"language-text\">Handler</code>의 생성자 설명 부분을 상기하라. <code class=\"language-text\">Handler</code>는 생성 시 <code class=\"language-text\">Looper</code>를 명시적으로 받으면 <code class=\"language-text\">Looper</code>를 가지고 있는 <code class=\"language-text\">Thread</code>에 연결된다.</p>\n<p><code class=\"language-text\">HandlerThread</code>의 소스코드를 보면 정말 간단하게 구현되어 있다는 것을 알 수 있다. 앞서 소개한 <code class=\"language-text\">LooperThread</code>예제와 <code class=\"language-text\">HandlerThread</code>의 구현 코드를 비교해 보자.</p>\n<ul>\n<li><code class=\"language-text\">LooperThread</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">LooperThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span> mHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// process incoming messages here</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">HandlerThread</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HandlerThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Thread</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Looper</span> mLooper<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mTid <span class=\"token operator\">=</span> <span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token function\">myTid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mLooper <span class=\"token operator\">=</span> <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">myLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token function\">notifyAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token class-name\">Process</span><span class=\"token punctuation\">.</span><span class=\"token function\">setThreadPriority</span><span class=\"token punctuation\">(</span>mPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">onLooperPrepared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        mTid <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>한 눈에 보기에도 비슷하다. <code class=\"language-text\">run()</code> 메서드가 실행될 때 <code class=\"language-text\">Looper.prepare()</code>와 <code class=\"language-text\">Looper.loop()</code>를 호출한다. 위 예제에서 <code class=\"language-text\">prepare()</code>와 <code class=\"language-text\">loop()</code> 사이에 코드를 넣었던 것처럼 오버라이딩을 통해 custom code를 넣을 수 있도록 <code class=\"language-text\">protected void onLooperPrepared() { }</code>이라는 빈 메서드도 제공된다.위 예제처럼 <code class=\"language-text\">Thread</code> 내부에서 <code class=\"language-text\">Handler</code>를 세팅하는 예시를 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomHandlerThread</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">HandlerThread</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Handler</span> mHandler<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onLooperPrepared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onLooperPrepared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// process incoming messages here</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>(TODO</p>\n<h4>5.2. LifeCycle</h4>\n<h4>5.3. Use Case(?)</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Repeated Task Execution\nRelated Task\n    Example - SharedPref\nTask chaining\n    Example - chained network calls\nConditional Task Insertion</code></pre></div>\n<p>)</p>\n<h3>6. AsyncTask</h3>\n<p>Source Code : <a href=\"https://github.com/android/platform_frameworks_base/blob/master/core/java/android/os/AsyncTask.java\">platform<em>frameworks</em>base/core/java/android/os/AsyncTask.java</a></p>\n<p><code class=\"language-text\">AsyncTask</code>는 안드로이드에서 가장 많이 쓰이는 비동기 처리 방식 중 하나로, 단어의 뜻 그대로 UI thread에서 하기 힘든 오래 걸리는 task들을 비동기적으로 처리하기 위해 만들어졌다. UI thread에서만 사용해야 하며, <code class=\"language-text\">Thread</code>나 <code class=\"language-text\">Handler</code> 등을 고려하지 않고 편하게 background task를 수행할 수 있도록 해 준다.</p>\n<h4>6.1. Basis</h4>\n<p><code class=\"language-text\">AsyncTask</code>의 소스 코드를 보면, <code class=\"language-text\">AsyncTask</code> 역시 <code class=\"language-text\">Handler</code>와 <code class=\"language-text\">Looper</code>를 사용한다. <code class=\"language-text\">InternalHandler</code>이라는 inner class의 소스 코드를 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">InternalHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Handler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">InternalHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Looper</span><span class=\"token punctuation\">.</span><span class=\"token function\">getMainLooper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RawUseOfParameterizedType\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">AsyncTaskResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">AsyncTaskResult</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> msg<span class=\"token punctuation\">.</span>obj<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">.</span>what<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">case</span> MESSAGE_POST_RESULT<span class=\"token operator\">:</span>\n                <span class=\"token comment\">// There is only one result</span>\n                result<span class=\"token punctuation\">.</span>mTask<span class=\"token punctuation\">.</span><span class=\"token function\">finish</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>mData<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">case</span> MESSAGE_POST_PROGRESS<span class=\"token operator\">:</span>\n                result<span class=\"token punctuation\">.</span>mTask<span class=\"token punctuation\">.</span><span class=\"token function\">onProgressUpdate</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>mData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>private로 선언된 <code class=\"language-text\">InternalHandler</code>은 오직 <code class=\"language-text\">AsyncTask</code> 내부에서만 접근 가능하며, Main Looper - UI Thread의 Looper - 와 결합하는 Handler이다. 하지만 <code class=\"language-text\">doInBackground()</code>라는 메서드를 통해 데이터를 주고받음으로서 <code class=\"language-text\">Handler</code> 관련 부분은 내부적으로만 작동하게 된다.</p>\n<p><code class=\"language-text\">AsyncTask</code>는 <code class=\"language-text\">AsyncTask&lt;Params, Progress, Result&gt;</code>를 상속받아 이용하는데, 미리 정의된 <code class=\"language-text\">protected</code> 메서드들을 오버라이딩하여 사용한다. <code class=\"language-text\">AsyncTask</code>에서 재정의할 수 있는 모든 콜백 메서드들을 구현하면 다음과 같은 코드를 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FullTask</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AsyncTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Params</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Progress</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Result</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onPreExecute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token class-name\">Result</span> <span class=\"token function\">doInBackground</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Params</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onProgressUpdate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Progress</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> progress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onPostExecute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span> result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token annotation punctuation\">@Override</span>\n\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCancelled</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span> result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 중 <code class=\"language-text\">doInBackground()</code> 메서드는 <code class=\"language-text\">abstract</code>로 선언되어 필수적으로 구현해야 하며, 다른 메서드들은 필요에 따라 구현하면 된다. <code class=\"language-text\">AsyncTask&lt;Params, Progress, Result&gt;</code>에서 generic type의 경우, <code class=\"language-text\">Params</code>에는 background thread로 넘겨 줄 input data를, <code class=\"language-text\">Progress</code>에는 background thread에서 UI thread로 넘겨 줄 progress data를, <code class=\"language-text\">Result</code>에는 최종적으로 background thread에서 UI thread로 넘겨 줄 result data를 설정해 주면 된다. 이 때 generic type을 이용하지 않으려면 <code class=\"language-text\">void</code>를 넣어 unused라는 표시를 해 주어야 한다.</p>\n<p>[그림]</p>\n<p>위의 그림은 <code class=\"language-text\">FullTask</code>가 실행될 때 일어나는 일들을 시간 순으로 그린 것이다. 먼저 <code class=\"language-text\">AsyncTask.execute(Params)</code>가 호출되면 UI thread에서 <code class=\"language-text\">onPreExecute()</code>가 실행된다. 그 후 background thread에서 <code class=\"language-text\">doInBackground(Params)</code>가 실행되는데, 이 동안 <code class=\"language-text\">doInBackground(Params)</code> 내부에서 <code class=\"language-text\">publishProgress(Progress)</code>를 호출하면 UI thread에서는 <code class=\"language-text\">onProgressUpdate(Progress)</code>가 실행되어 UI를 업데이트 할 수 있다. <code class=\"language-text\">doInBackground(Params)</code> 메서드가 실행을 마치면 결과값을 파라미터로 넘겨 UI thread에서 <code class=\"language-text\">onPostExecute(Result)</code>가 실행되어 결과값을 반영할 수 있다. <code class=\"language-text\">AsyncTask</code>가 cancel된 경우, <code class=\"language-text\">onCancelled(Result)</code> 메서드가 대신 실행되어 결과를 처리하게 된다.</p>\n<p>참고 : <code class=\"language-text\">finish()</code> 메서드</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">finish</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Result</span> result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isCancelled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">onCancelled</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">onPostExecute</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    mStatus <span class=\"token operator\">=</span> <span class=\"token class-name\">Status</span><span class=\"token punctuation\">.</span>FINISHED<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">AsyncTask</code>는 소스 코드 주석에서 subclass를 만들어 사용하기를 강력히 권장하고 있으며, 사용 방법은 subclass를 만들고, 생성자를 통해 생성, <code class=\"language-text\">AsynTask.execute()</code> 메서드를 통해 실행하는 것이다. 주의할 점은 <code class=\"language-text\">AsyncTask</code> 클래스는 UI thread에 load 되어야 하며 - Jelly Bean 부터는 자동으로 해 준다 - 인스턴스 역시 UI 스레드에 생성되어야 한다. 또한 <code class=\"language-text\">execute()</code> 역시 UI 스레드에서 실행되어야 하고, 한 번만 실행될 수 있다.</p>\n<p><code class=\"language-text\">execute(Params)</code>가 실행될 때, <code class=\"language-text\">Params</code>는 <code class=\"language-text\">AsyncTask</code>로 전달되고, <code class=\"language-text\">doInBackground(Params)</code> 메서드를 통해 Background thread로 전달된다. Background thread에서 처리된 데이터는 UI thread의 <code class=\"language-text\">Looper</code>와 결합되어 있는 <code class=\"language-text\">InternalHandler</code>로 보내지며, dispatch 과정을 거쳐 - 위 코드의 <code class=\"language-text\">handleMessage()</code> 부분을 보라 - UI thread에서 처리된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">boolean</span> mayInterruptIfRunning<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mCancelled<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> mFuture<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span>mayInterruptIfRunning<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">AsyncTask</code>를 cancel하는 방법은은 두 가지가 있는데, interrupt를 하는 것과 하지 않는 것이다. <code class=\"language-text\">mayInterruptIfRunning</code>을 true로 하게 되면 <code class=\"language-text\">Thread.interrupt()</code>가 호출되어 <code class=\"language-text\">InterruptedException e</code>가 발생하고, <code class=\"language-text\">Thread.isInterrupted()</code> 플래그가 true가 된다. Interrupt가 일어나게 되면 blocking method call을 벗어나 바로 cancel 작업을 수행하게 된다. 반면, Interrupt를 하지 않을 경우 하던 작업을 계속하며 <code class=\"language-text\">mCancelled</code>만 <code class=\"language-text\">true</code>가 되는데, 내부에 루프가 있을 경우 - 예를 들면 사진 여러 장을 가져오는 등 - <code class=\"language-text\">isCancelled()</code> 값 검사를 통해 일정 작업 단위를 기준으로 cancel할 수 있다. 두 경우 모두 <code class=\"language-text\">doInBackground(Params)</code>에서 - <code class=\"language-text\">Result</code>가 <code class=\"language-text\">void</code>가 아니라면 - <code class=\"language-text\">Result</code>를 반환해 주어야 하며, <code class=\"language-text\">doInBackground(Params)</code> 실행 후 <code class=\"language-text\">onPostExecute(Result)</code> 대신 <code class=\"language-text\">onCancelled(Result)</code>가 호출된다.</p>\n<p><code class=\"language-text\">AsyncTask</code>는 3개의 state를 가지는데, <code class=\"language-text\">PENDING</code>, <code class=\"language-text\">RUNNING</code>, <code class=\"language-text\">FINISHED</code>이다. <code class=\"language-text\">AsyncTask</code> 인스턴스가 만들어지면 <code class=\"language-text\">PENDING</code> state에 있다가 <code class=\"language-text\">execute()</code>가 실행되면 <code class=\"language-text\">RUNNING</code> state로 변하고, <code class=\"language-text\">onPostExecute()</code>나 <code class=\"language-text\">onCancelled()</code>가 실행을 마치면 <code class=\"language-text\">FINISHED</code> state가 된다. 한 번 <code class=\"language-text\">RUNNING</code> state로 진입한 <code class=\"language-text\">AsyncTask</code>는 다시 실행될 수 없으며, 새로운 인스턴스를 만들어 실행해야 한다. <code class=\"language-text\">AsyncTask</code>의 state는 간단히 <code class=\"language-text\">AsyncTask.getStatus()</code> 메서드로 확인할 수 있다.</p>\n<h4>6.2. Implementation</h4>\n<p>간단해 보이는 <code class=\"language-text\">AsyncTask</code>이지만, 항상 <code class=\"language-text\">Context</code>의 lifecycle을 염두에 두고 잘 맞추어서 사용해야 한다. 구글이 권장하는 대로 <code class=\"language-text\">AsyncTask</code>를 <code class=\"language-text\">Activity</code>와 같은 view 안의 inner class로 선언되고 레퍼런스 될 경우, view가 없어지더라도 <code class=\"language-text\">AsyncTask</code>가 종료되지 않으면 view의 메모리가 반환되지 않고 남아 있는 문제가 생긴다. 이러한 문제를 해결하기 위해서 static inner class로 선언하는 방식이 많이 쓰인다. <a href=\"http://stackoverflow.com/questions/3821423/background-task-progress-dialog-orientation-change-is-there-any-100-working/3821998#3821998\">이 스레드</a>에서 자세히 설명하고 있다.\n또한 위에서 언급한 cancellation에 대해 policy를 정해 처리해 주어야 한다. 예시 코드를 소개하고 넘어가겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AsyncTaskActivity</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Activity</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token class-name\">URLs</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">\"url1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"url2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"url3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"url4\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">DownloadTask</span> downloadTask<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">ProgressBar</span> progressBar<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">LinearLayout</span> linearLayout\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bundle</span> savedInstanceState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>savedInstanceState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> findViewByIds<span class=\"token punctuation\">,</span> etc <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n        downloadTask <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DownloadTask</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        downloadTask<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">URLs</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onDestroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        downloadTask<span class=\"token punctuation\">.</span><span class=\"token function\">setActivity</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        downloadTask<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DownloadTask</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AsyncTask</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">AsyncTaskActivity</span> mActivity<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">DownloadTask</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AsyncTaskActivity</span> activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mActivity <span class=\"token operator\">=</span> activity<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setActivity</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AsyncTaskActivity</span> activity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            mActivity <span class=\"token operator\">=</span> activity<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onPreExecute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onPreExecute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mActivity<span class=\"token punctuation\">.</span>mProgressBar<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>VISIBLE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            mActivity<span class=\"token punctuation\">.</span>mProgressBar<span class=\"token punctuation\">.</span><span class=\"token function\">setProgress</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Void</span> <span class=\"token function\">doInBackground</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> urls<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> url <span class=\"token operator\">:</span> urls<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isCancelled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// Simulate Downloading</span>\n                    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">300</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token class-name\">String</span> fileName <span class=\"token operator\">=</span> <span class=\"token string\">\"FileNameBy\"</span><span class=\"token operator\">+</span>url<span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">publishProgress</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onProgressUpdate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> fileNames<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onProgressUpdate</span><span class=\"token punctuation\">(</span>fileNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActivity <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token class-name\">TextView</span> tv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextView</span><span class=\"token punctuation\">(</span>mActivity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\ttv<span class=\"token punctuation\">.</span><span class=\"token function\">setText</span><span class=\"token punctuation\">(</span>fileNames<span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t    \tmActivity<span class=\"token punctuation\">.</span>mProgressBar<span class=\"token punctuation\">.</span><span class=\"token function\">setProgress</span><span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t\tmActivity<span class=\"token punctuation\">.</span>linearLayout<span class=\"token punctuation\">.</span><span class=\"token function\">addView</span><span class=\"token punctuation\">(</span>tv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\n\t\t<span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onPostExecute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Void</span> aVoid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onPostExecute</span><span class=\"token punctuation\">(</span>aVoid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActivity <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t        mActivity<span class=\"token punctuation\">.</span>mProgressBar<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>GONE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t    <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token annotation punctuation\">@Override</span>\n\t\t<span class=\"token keyword\">protected</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onCancelled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCancelled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mActivity <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t        mActivity<span class=\"token punctuation\">.</span>mProgressBar<span class=\"token punctuation\">.</span><span class=\"token function\">setVisibility</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">View</span><span class=\"token punctuation\">.</span>GONE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t    <span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>(TODO</p>\n<h4>6.3. Execution Options</h4>\n<h4>6.4. Pitfalls</h4>\n<p>Common pitfalls\nwhen not to use</p>\n<p>)</p>\n<p><a href=\"http://suribada.com/wp/?p=13\">http://suribada.com/wp/?p=13</a>\n<a href=\"http://therne.me/?p=76\">http://therne.me/?p=76</a>\n<a href=\"http://javacan.tistory.com/entry/maintainable-async-processing-code-based-on-AsyncTask\">http://javacan.tistory.com/entry/maintainable-async-processing-code-based-on-AsyncTask</a>\n<a href=\"http://blog.danlew.net/2014/06/21/the-hidden-pitfalls-of-asynctask/\">http://blog.danlew.net/2014/06/21/the-hidden-pitfalls-of-asynctask/</a>\n<a href=\"http://bon-app-etit.blogspot.kr/2013/04/the-dark-side-of-asynctask.html\">http://bon-app-etit.blogspot.kr/2013/04/the-dark-side-of-asynctask.html</a></p>\n<h3>7. Executor</h3>\n<p><a href=\"http://blog.bsidesoft.com/?p=311&#x26;fb_ref=AL2FB\">http://blog.bsidesoft.com/?p=311&#x26;fb_ref=AL2FB</a></p>\n<h3>8. IntentService</h3>\n<p><a href=\"https://realm.io/news/android-threading-background-tasks/\">https://realm.io/news/android-threading-background-tasks/</a></p>\n<h3>9. Loader</h3>\n<p><a href=\"http://www.vogella.com/tutorials/AndroidBackgroundProcessing/article.html#concurrency_asynchtask_parallel\">http://www.vogella.com/tutorials/AndroidBackgroundProcessing/article.html#concurrency_asynchtask_parallel</a></p>\n<h3>10. Select MultiThreading Method</h3>\n<p><a href=\"http://www.slideshare.net/andersgoransson/efficient-android-threading\">http://www.slideshare.net/andersgoransson/efficient-android-threading</a></p>\n<hr>\n<p>Ref\n<a href=\"http://frontjang.info/443\">http://frontjang.info/443</a></p>\n<p><a href=\"http://huewu.blog.me/110115454542\">http://huewu.blog.me/110115454542</a>\n<a href=\"http://huewu.blog.me/110116293622\">http://huewu.blog.me/110116293622</a></p>\n<p><a href=\"http://blog.nikitaog.me/2014/10/11/android-looper-handler-handlerthread-i/\">http://blog.nikitaog.me/2014/10/11/android-looper-handler-handlerthread-i/</a>\n<a href=\"http://blog.nikitaog.me/2014/10/18/android-looper-handler-handlerthread-ii/\">http://blog.nikitaog.me/2014/10/18/android-looper-handler-handlerthread-ii/</a>\n<a href=\"https://corner.squareup.com/2013/10/android-main-thread-1.html\">https://corner.squareup.com/2013/10/android-main-thread-1.html</a>\n<a href=\"https://corner.squareup.com/2013/12/android-main-thread-2.html\">https://corner.squareup.com/2013/12/android-main-thread-2.html</a>\n<a href=\"http://codetheory.in/android-handlers-runnables-loopers-messagequeue-handlerthread/\">http://codetheory.in/android-handlers-runnables-loopers-messagequeue-handlerthread/</a></p>\n<p><a href=\"http://ensider.tistory.com/5\">http://ensider.tistory.com/5</a></p>","fields":{"slug":"android-multithreading"},"frontmatter":{"title":"Android Multithreading","date":"22 Oct, 2015","description":"Details of Android Multithreading","tags":["java","android","multithreading"],"cover":{"publicURL":"/static/preview-c5455146c94f9d021125ddcaf8d590cf.jpg","childImageSharp":{"fluid":{"tracedSVG":"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='62'%20height='62'%3e%3cpath%20d='M12%204l3%206h-3c-4%200-6%200-9%202l-3%202v14c0%2014%201%2015%205%2016%203%201%203-2%200-3l-1-1c3-1%207%201%207%203%201%204%2010%205%2011%203%201-3%203-2%204%200l2%202c2%200%202%202%201%204-2%203%200%205%207%204%206%200%206%200%205%204v2l1-1%203-1c3%202%2011%202%2011%201h2l4%201v-5l-2-1%201-1c2%201%201-10%200-12v-1c2-1%203-28%201-30l-4-3-5-1c-2-1-2-1%200%203v12c-1%201-1%201-1-1s0-2-4-2l-10%202c-8%200-8%201-8%205%200%205-2%204-2-1%200-3%200-3-1-2%200%202-1%201-1-3l-2-8c0-2%200-2%201-1s1-1-1-5h1l3%204%201%204h5l10-2c7%200%208-3%204-7-2-2-2-2%200-2l3-1c2-1%201-1-3-1l-9-2h-5l1%202v4c-1%200-2-1-2-3l-1-3H11l1%204M0%2027c0%2010%200%2011%201%206l1-4c0%203%203%206%204%204l2-1%201-3%203-3c3-2%204-1%204%202s0%203%203%203c2%200%203%200%204%203s2%203%201%201h1v-8l-1-3c0-4-5-8-11-8-5%200-11%205-11%209l-1-5c-1-5-1-4-1%207m39%203l-9%205h4l-1%201c-2%200-1%202%202%203l2%202-4-1-3-1%202%202%201%202%201%201%201%202c2%206%2011%207%2019%204%203-2%204-2%204-6v-6h-1l-1%202c-2%200-2-2-2-7l-3-2-3-1h-9'%20fill='%23d3d3d3'%20fill-rule='evenodd'/%3e%3c/svg%3e","aspectRatio":1.7777777777777777,"src":"/static/c5455146c94f9d021125ddcaf8d590cf/7b798/preview.jpg","srcSet":"/static/c5455146c94f9d021125ddcaf8d590cf/e441c/preview.jpg 293w,\n/static/c5455146c94f9d021125ddcaf8d590cf/79cf3/preview.jpg 585w,\n/static/c5455146c94f9d021125ddcaf8d590cf/7b798/preview.jpg 1170w,\n/static/c5455146c94f9d021125ddcaf8d590cf/66597/preview.jpg 1280w","srcWebp":"/static/c5455146c94f9d021125ddcaf8d590cf/2e5a7/preview.webp","srcSetWebp":"/static/c5455146c94f9d021125ddcaf8d590cf/05ceb/preview.webp 293w,\n/static/c5455146c94f9d021125ddcaf8d590cf/5c538/preview.webp 585w,\n/static/c5455146c94f9d021125ddcaf8d590cf/2e5a7/preview.webp 1170w,\n/static/c5455146c94f9d021125ddcaf8d590cf/e170b/preview.webp 1280w","sizes":"(max-width: 1170px) 100vw, 1170px"}}}}},"allMarkdownRemark":{"edges":[]}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"android-multithreading","previous":null,"next":null,"tag":["java","android","multithreading"]}}}